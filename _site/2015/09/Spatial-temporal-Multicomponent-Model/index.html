<!DOCTYPE html>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="author" content="Spatial-R" />
        <title>surveillance 程序包简介(一):时空多成分模型 | Spatial-R</title>
        <link rel="shortcut icon" href="/favicon.ico">
          <link href="http://spatial-r.github.io/cn/feed/" rel="alternate" title="Spatial-R" type="application/atom+xml" />
            <link rel="stylesheet" href="/media/css/style.css">
              <link rel="stylesheet" href="/media/css/highlight.css">
                <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
                  <!--highlight.js Start-->
                  <link rel="stylesheet" title="Default" href="/media/js/styles/tomorrow-night-blue.css">
                    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
                      <script>
                      hljs.configure({tabReplace: '    '});
                    hljs.initHighlightingOnLoad();
                    </script>
                      <!--highlight.js End-->
                      <!--mathjax start-->
                      <script type="text/javascript"
                      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
                        </script>
                        
                        <!--mathjax end-->
                        </head>
                        <body>
                        <div id="container">
                          <div id="main" role="main">
                            <header>
                            <h1>surveillance 程序包简介(一):时空多成分模型</h1>
                            </header>
                            <nav>
                            <!-- Sidebar -->
                            <h5 id="logo" style="text-align:center;">
                              <a href="http://spatial-r.github.io/">主页</a></h5>
                                <span><a title="blog" class="" href="http://spatial-r.github.io/cn/">博客</a></span>
                                  <span><a title="about" class="" href="http://spatial-r.github.io/cn/about/">关于</a></span>
                                    <span><a title="categories" class="" href="http://spatial-r.github.io/cn/categories/">分类</a></span>
                                      <span><a title="vitae" class="" href="http://spatial-r.github.io/cn/vitae/">简历</a></span>
                                        <span><a title="tags" class="" href="http://spatial-r.github.io/cn/tags/">标签</a></span>
                                          <span><a title="links" class="" href="http://spatial-r.github.io/cn/links/">链接</a></span>
                                            <span><a title="subscribe by RSS" class="" href="http://spatial-r.github.io/cn/feed/">订阅</a></span>
                                              </nav>
                                              <article class="content">
                                              <section class="post">
<p>Welocome to the surveillance project again! 这是一篇针对<a href="http://surveillance.r-forge.r-project.org/">Surveillance</a>程序包中<strong>时空多成分模型</strong>( <strong>Spatial-temporal Multicomponent Model</strong>)的文章。时空多成分模型是surveillance程序包提供的四大分析模块之一(<strong>Outbreaks detection</strong>, <strong>Endemic-epidemic Spatio-temporal Point Process Intensity Model</strong>, <strong>SIR event history of a fixed population</strong> 和 <strong>Spatial-temporal Multicomponent Model</strong>)，自去年10月份开始接触，期间走了很多弯路(学习过程)，故将相关教训在此文中分享，希望对时空流行病学感兴趣的朋友能够尽快熟悉该模型并能应用于自己的数据。英文功底不错的建议阅读该程序包的英文说明<a href="http://arxiv.org/pdf/1411.0416.pdf">文档</a>。如果您发现此文中的错误，也恳请留言指出，在此特表感谢。</p>

<hr />

<h2>模型综述</h2>

<p>时空多成分模型(Spatial-temporal Multicomponent Model)的简约版最初由<a href="http://www.researchgate.net/profile/Michael_Hoehle/publication/45138457_A_statistical_framework_for_the_analysis_of_multivariate_infectious_disease_surveillance_data/links/0c960520b310bb8378000000.pdf">Held et al. (2005)</a>提出，并应用于麻疹疫情中[PS: 基于浙江省麻疹疫情已写了篇类似的文章，已投中华流行病学杂志]。<a href="http://biostatistics.oxfordjournals.org/content/7/3/422.full">Leonhard Held et al.(2006)</a>在“A two-componet model for counts of infectious disease”一文中构建了随机双成分(<strong>相互独立</strong>)模型，包括<strong>局部特性成分</strong>(Endemic Component)和<strong>时间流行成分</strong>(Epidemic  Component)，其中局部特性成分控制季节效应的影响，时间流行成分同时考虑了疾病疫情的时间相关性和暴发影响。该模型假设时序数据服从Generalised Branching Process with Immigration，
并分别对甲肝和乙肝进行了拟合。在surveillance程序包中，基础模型中将时序数据分为三个成分：局部特性成分(Endemic component, end)、时间自相关成分(Autoregressive component，ar)和空间流行成分(Epidemic component, ne)，并在公式中分别用$ν<em>(i,t)$、$λ</em>(i,t)$和$ϕ_(i,t)$表示。其中局部特性成分反映疫情的本地风险情况，时间自相关成分反映的是过去时段疫情在时间维度上产生的影响，而空间流行成分反映的是邻近单元对目标单元产生的影响(可根据多种空间权重矩阵来定义<strong>邻近</strong>)。具体的公式如下：</p>

<p><img src="https://raw.githubusercontent.com/Spatial-R/cn/gh-pages/images/MulticomponentModel/mathjax.png" alt="" /></p>

<p>$γ<em>0$、$α</em>0$  和 $β<em>0$分别代表了三成分的截距，$γ</em>i$、$α<em>i$  和 $β</em>i$ 分别代表三成分的随机效应，都服从均值为0的正态分布；γ、α 和 β分别代表了协变量 $z<em>(i,t)<sup>T</sup>$、$μ</em>(i,t)<sup>T</sup>$  和 $x<em>(i,t)<sup>T</sup>$ 对局部特性成分、时间自相关成分和空间流行成分的作用强度。其中协变量$z</em>(i,t)<sup>T</sup>$在本研究中包含了季节效应${∑<em>(s=1)<sup>S</sup>[κ</em>s  sina(τ<em>s t)+δ</em>s cosa(τ<em>s t)]}$，其中S代表周期数，$τ</em>s=2πs/freq$。</p>

<hr />

<h2>模型优点</h2>

<p>surveillance程序包中的时空多成分模型相关优点主要体现在如下几个方面：</p>

<ol>
<li><strong>空间权重</strong>：多种方式定义研究单元的邻近性</li>
<li><strong>协变量纳入</strong>：自变量反映局部和时序关系</li>
<li><strong>随机效应</strong>：考虑区域的空间异质性</li>
</ol>


<p>空间权重对空间分析影响较大，其设置方式是空间分析中老生常谈的话题。surveillance程序包除提高基本的空间权重矩阵外(如一阶queen邻近等，具体见<a href="https://cran.r-project.org/web/packages/spdep/index.html">spdep</a>程序包)，还提供<a href="http://www.medscape.com/medline/abstract/24843881"><strong>Power-law</strong></a>算法，能更好模拟传染病远距离传播的特性(在一定距离范围内快速递减)。</p>

<p>协变量纳入不仅可在控制其他效应后准确度量协变量和结局变量之间的关系，也能较高地提高模型拟合度(AIC)。协变量一般纳入局部特性成分或时间自相关成分，借以反映其在局部疫情风险和时序效果上的影响，当然，将协变量得系数恒设为1进而转变成offset。不管何种方式，都可以借助AIC值来选择最优拟合模型，尽管有研究表明将易感人群比例值纳入时间自相关成分效果较佳(见<a href="http://journals.cambridge.org/article_S0950268810001664">此文</a>)。</p>

<p>随机效应在协变量不能完全反映研究单元的空间异质性时，能显著提高模型的预测力。时空多成分模型中纳入随机效应最初由<a href="http://onlinelibrary.wiley.com/doi/10.1002/sim.4177/abstract">M. Paul and Held L(2010)</a>提出，极大提高了模型的适用度。对于传染病大疫情的监测数据，无法观测的空间异质性主要体现在underreporting。针对不同研究单元不同成分随机效应的可视化，可为卫生决策者提供较好的干预措施，若某区域麻疹的局部特性成分较大，则说明麻疹疫情的本地风险较大，进一步巩固本地免疫屏障则显得尤为重要。</p>

<hr />

<h2>具体实例</h2>

<h3>STS格式文件</h3>

<p>surveillance程序包中提供<strong>hhh4</strong>函数来拟合时空多成分模型，其所需的数据格式为sts(surveillance time series)。sts数据需包括以下几个部分：<strong>疫情数据</strong>，<strong>人口数据</strong>，<strong>空间邻阶数据</strong>,<strong>地图数据</strong>或和<strong>协变量数据</strong>。可借助<strong>new</strong>函数生成sts数据，示例代码如下：</p>

<pre><code>measlesWeserEms &lt;- new("sts", start = c(2013, 1), freq =365, epoch = 1:nrow(dat.final),
                observed = dat.final, neighbourhood = weserems_nbOrder,
               map = dat.zj, populationFrac = populationFrac)
</code></pre>

<p>此处，我的数据是逐日数据，因而freq设置为365，dat,final是疫情数据，dat.zj是地图数据，populationFrac是人口比例数据(研究单元人口占总研究单元人口数的百分比)。此处一定需注意各个数据集之间匹配问题，也就是变量名一定要一致(重要的事情不说三遍!!!)。对于空间邻阶文件，可通过spdep程序包中的<strong>poly2adjmat</strong>和<strong>nbOrder</strong>函数来生成，但需注意孤立区域，如浙江省的洞头县尽管从地图属性是孤立的，但考虑传染病的扩散特性，还是将其设置为与乐清市相邻。</p>

<h3>数据可视化</h3>

<p>此处，利用surveillance自带的measlesWeserEms数据集来实现下面的操作：数据可视化和数据分析。时间序列可视化的部分代码如下：</p>

<pre><code class="r">library(surveillance)
data(measlesWeserEms)
measlesWeserEms15 &lt;- measlesWeserEms[, colSums(observed(measlesWeserEms)) &gt; 6]
plot(measlesWeserEms15, type =observed ~ time | unit, legend.opts = NULL)
</code></pre>

<p><img src="https://raw.githubusercontent.com/Spatial-R/cn/gh-pages/images/MulticomponentModel/visualization-2.png" alt="" /></p>

<p>你可以调节type参数的值，如“observed ~ time”或“observed ~ unit”等来达到不同的可视化效果，其采用的是spplot和lattice绘图系统，若想调节图形相关参数的可查阅程序包的帮助文档。当然，也可以用ggplot2和gridExtra程序包，分别实现数据可视化和图形组合(推荐之至)。</p>

<h3>模型拟合</h3>

<p>此处先拟合基础模型，其包括三成分，其中各研究单元的人口比例值作为offset结合地域面积来反映人口密度，局部特性成分控制季节效应，时间流行成分和空间流行成分(一阶邻近)都只包括截距项。为控制研究区域疫情的过度离散特性，采用负二项分布(NegBin1)进行拟合，当然也可以选择p泊松分布(Possion)。相关代码如下：</p>

<pre><code class="r">measlesModel_basic &lt;- list( 
end = list(f = addSeason2formula(~1 + t, period = measlesWeserEms@freq),offset = population(measlesWeserEms)), 
ar = list(f = ~1),ne = list(f = ~1, weights = neighbourhood(measlesWeserEms) == 1), family = "NegBin1")
measlesFit_basic &lt;- hhh4(stsObj = measlesWeserEms, control = measlesModel_basic)
summary(measlesFit_basic, idx2Exp = 1:4, amplitudeShift = TRUE, maxEV = TRUE)
</code></pre>

<pre><code>## 
## Call: 
## hhh4(stsObj = measlesWeserEms, control = measlesModel_basic)
## 
## Coefficients:
##                       Estimate   Std. Error
## exp(ar.1)              0.645403   0.079270 
## exp(ne.1)              0.015805   0.004200 
## exp(end.1)             1.080248   0.278839 
## exp(end.t)             1.001185   0.004264 
## end.A(2 * pi * t/52)   1.164231   0.192124 
## end.s(2 * pi * t/52)  -0.634360   0.133500 
## overdisp               2.013839   0.285441 
## 
## Epidemic dominant eigenvalue:  0.72 
## 
## Log-likelihood:   -971.72 
## AIC:              1957.44 
## BIC:              1995.72 
## 
## Number of units:        17 
## Number of time points:  103
</code></pre>

<p>summary函数中idx2Exp是一个简单系数转换参数，此处是将系数中的ar.1，ne.1，end.1和end.t转换成其对数值，至于为什么要转换，看看基础模型的公式即可知。Epidemic dominant eigenvalue表示疾病发病率中空间流行成分百分值，更进一步的可视化形式如下:</p>

<pre><code class="r">districts2plot &lt;- names(which(colSums(observed(measlesWeserEms)) &gt; 20))
plot(measlesFit_basic, type = "fitted", units = districts2plot, hide0s = TRUE)
</code></pre>

<p><img src="https://raw.githubusercontent.com/Spatial-R/cn/gh-pages/images/MulticomponentModel/visualization-2.png" alt="" /></p>

</section>
<section class="meta">



<span>
	<a  href="http://spatial-r.github.io/cn/2015/07/SPODT-IN-R/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a   class="pageNavInvalid"  >Next</a>
</span>


<span class="author">
  <a href="http://spatial-r.github.io/cn">Spatial-R</a>
</span>
<span class="time">
  /
  <time datetime="2015-09-13">2015-09-13</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="http://spatial-r.github.io/cn/categories/#统计" title="统计">统计</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="http://spatial-r.github.io/cn/tags/#surveillance" title="surveillance">surveillance</a>&nbsp;
  
  <a href="http://spatial-r.github.io/cn/tags/#时空多成分模型" title="时空多成分模型">时空多成分模型</a>&nbsp;
  
  <a href="http://spatial-r.github.io/cn/tags/#R" title="R">R</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname ='httpspatialrgithubio'; // required: replace example with your forum shortname
    var disqus_url = 'http://spatial-r.github.io/cn/2015/09/Spatial-temporal-Multicomponent-Model/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://spatial-r.github.io/cn/2015/07/SPODT-IN-R/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


                                              </article>
                                                </div>
                                                </div>
                                                <script type="text/javascript">
                                                  var _gaq = _gaq || [];
                                                  _gaq.push(['_setAccount', '']);
                                                  _gaq.push(['_trackPageview']);
                                                  (function() {
                                                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                                                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                                                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                                                  })();
                                                  </script>
                                                    </body>
                                                    </html>
                                                    